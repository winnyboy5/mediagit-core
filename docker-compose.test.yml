version: '3.8'

services:
  # MinIO - S3-compatible storage
  minio:
    image: minio/minio:latest
    container_name: mediagit-minio
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
      MINIO_DOMAIN: localhost
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 5s
      timeout: 5s
      retries: 5
    volumes:
      - minio-data:/data
    networks:
      - mediagit-test

  # MinIO Client - Create test buckets
  minio-init:
    image: minio/mc:latest
    container_name: mediagit-minio-init
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set myminio http://minio:9000 minioadmin minioadmin;
      mc mb myminio/mediagit-test --ignore-existing;
      mc mb myminio/mediagit-repos --ignore-existing;
      mc anonymous set download myminio/mediagit-test;
      mc anonymous set download myminio/mediagit-repos;
      exit 0;
      "
    networks:
      - mediagit-test

  # Azurite - Azure Blob Storage emulator
  azurite:
    image: mcr.microsoft.com/azure-storage/azurite:latest
    container_name: mediagit-azurite
    ports:
      - "10000:10000"  # Blob service
      - "10001:10001"  # Queue service
      - "10002:10002"  # Table service
    command: azurite-blob --blobHost 0.0.0.0 --blobPort 10000 --location /data --debug /tmp/azurite.log
    volumes:
      - azurite-data:/data
    networks:
      - mediagit-test
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "10000"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Azurite Init - Create test containers
  azurite-init:
    image: mcr.microsoft.com/azure-cli:latest
    container_name: mediagit-azurite-init
    depends_on:
      azurite:
        condition: service_healthy
    environment:
      AZURE_STORAGE_CONNECTION_STRING: "DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==;BlobEndpoint=http://azurite:10000/devstoreaccount1;"
    entrypoint: >
      /bin/sh -c "
      az storage container create --name mediagit-test --connection-string \"$$AZURE_STORAGE_CONNECTION_STRING\" || true;
      az storage container create --name mediagit-repos --connection-string \"$$AZURE_STORAGE_CONNECTION_STRING\" || true;
      exit 0;
      "
    networks:
      - mediagit-test

  # GCS Emulator - Google Cloud Storage
  gcs-emulator:
    image: fsouza/fake-gcs-server:latest
    container_name: mediagit-gcs
    ports:
      - "4443:4443"
    command: -scheme http -host 0.0.0.0 -port 4443 -external-url http://localhost:4443
    volumes:
      - gcs-data:/data
    networks:
      - mediagit-test
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "4443"]
      interval: 5s
      timeout: 5s
      retries: 5

  # LocalStack - Alternative AWS services emulator (optional)
  # localstack:
  #   image: localstack/localstack:latest
  #   container_name: mediagit-localstack
  #   ports:
  #     - "4566:4566"
  #   environment:
  #     SERVICES: s3
  #     DEBUG: 1
  #     DATA_DIR: /tmp/localstack/data
  #   volumes:
  #     - localstack-data:/tmp/localstack
  #   networks:
  #     - mediagit-test

volumes:
  minio-data:
    driver: local
  azurite-data:
    driver: local
  gcs-data:
    driver: local
  # localstack-data:
  #   driver: local

networks:
  mediagit-test:
    driver: bridge
    name: mediagit-test-network
