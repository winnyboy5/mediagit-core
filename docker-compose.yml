# MediaGit Test Infrastructure
# Usage:
#   docker compose up -d                          # Start core services (MinIO, Azurite, GCS)
#   docker compose --profile localstack up -d     # Include LocalStack for full AWS S3 testing
#   docker compose down -v                        # Stop and remove volumes

services:
  # ============================================================================
  # MinIO - S3-Compatible Object Storage (Primary)
  # ============================================================================
  minio:
    image: minio/minio:latest
    container_name: mediagit-minio
    ports:
      - "9000:9000"      # S3 API
      - "9001:9001"      # Console UI
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
      MINIO_REGION: us-east-1
      MINIO_DOMAIN: localhost
    command: server /data --console-address ":9001"
    volumes:
      - minio-data:/data
    networks:
      - mediagit-test
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s

  minio-init:
    image: minio/mc:latest
    container_name: mediagit-minio-init
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set myminio http://minio:9000 minioadmin minioadmin;
      mc mb myminio/mediagit-test --ignore-existing;
      mc mb myminio/mediagit-repos --ignore-existing;
      mc mb myminio/mediagit-integration-tests --ignore-existing;
      mc anonymous set download myminio/mediagit-test;
      echo 'MinIO buckets created successfully!';
      exit 0;
      "
    networks:
      - mediagit-test

  # ============================================================================
  # Azurite - Azure Blob Storage Emulator
  # ============================================================================
  azurite:
    image: mcr.microsoft.com/azure-storage/azurite:latest
    container_name: mediagit-azurite
    ports:
      - "10000:10000"  # Blob service
      - "10001:10001"  # Queue service
      - "10002:10002"  # Table service
    command: azurite-blob --blobHost 0.0.0.0 --blobPort 10000 --location /data --loose --debug /tmp/azurite.log
    volumes:
      - azurite-data:/data
    networks:
      - mediagit-test
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 10000 || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 5s

  azurite-init:
    image: mcr.microsoft.com/azure-cli:latest
    container_name: mediagit-azurite-init
    depends_on:
      azurite:
        condition: service_healthy
    environment:
      AZURE_STORAGE_CONNECTION_STRING: "DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==;BlobEndpoint=http://azurite:10000/devstoreaccount1;"
    entrypoint: >
      /bin/sh -c "
      az storage container create --name mediagit-test --connection-string \"$$AZURE_STORAGE_CONNECTION_STRING\" 2>/dev/null || true;
      az storage container create --name mediagit-repos --connection-string \"$$AZURE_STORAGE_CONNECTION_STRING\" 2>/dev/null || true;
      echo 'Azurite containers created successfully!';
      exit 0;
      "
    networks:
      - mediagit-test

  # ============================================================================
  # Fake GCS Server - Google Cloud Storage Emulator
  # ============================================================================
  gcs-emulator:
    image: fsouza/fake-gcs-server:latest
    container_name: mediagit-gcs
    ports:
      - "4443:4443"
    command:
      - -scheme
      - http
      - -host
      - 0.0.0.0
      - -port
      - "4443"
      - -external-url
      - http://localhost:4443
    volumes:
      - gcs-data:/data
    networks:
      - mediagit-test
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:4443/storage/v1/b"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 5s

  gcs-init:
    image: curlimages/curl:latest
    container_name: mediagit-gcs-init
    depends_on:
      gcs-emulator:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      curl -s -X POST 'http://gcs-emulator:4443/storage/v1/b?project=test-project' \
        -H 'Content-Type: application/json' \
        -d '{\"name\": \"mediagit-test\"}' || true;
      curl -s -X POST 'http://gcs-emulator:4443/storage/v1/b?project=test-project' \
        -H 'Content-Type: application/json' \
        -d '{\"name\": \"mediagit-repos\"}' || true;
      echo 'GCS buckets created successfully!';
      exit 0;
      "
    networks:
      - mediagit-test

  # ============================================================================
  # LocalStack - Full AWS Emulator (Optional - use with --profile localstack)
  # ============================================================================
  localstack:
    image: localstack/localstack:latest
    container_name: mediagit-localstack
    profiles:
      - localstack
    ports:
      - "4566:4566"           # LocalStack edge port
      - "4510-4559:4510-4559" # External services port range
    environment:
      SERVICES: s3
      AWS_DEFAULT_REGION: us-east-1
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test
      DEBUG: 1
      DATA_DIR: /tmp/localstack/data
    volumes:
      - ./scripts/init-aws.sh:/etc/localstack/init/ready.d/init-aws.sh
      - localstack-data:/tmp/localstack
    networks:
      - mediagit-test
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

# ============================================================================
# Volumes - Persistent storage for each service
# ============================================================================
volumes:
  minio-data:
    driver: local
  azurite-data:
    driver: local
  gcs-data:
    driver: local
  localstack-data:
    driver: local

# ============================================================================
# Networks
# ============================================================================
networks:
  mediagit-test:
    driver: bridge
    name: mediagit-test-network
